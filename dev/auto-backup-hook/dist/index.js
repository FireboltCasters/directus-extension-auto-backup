"use strict";var n=require("fs"),e=require("path");function t(n){return n&&"object"==typeof n&&"default"in n?n:{default:n}}var i=t(n),a=t(e);const l=class{constructor(n,e,t){this.services=n,this.database=e,this.schema=t}getItemsService(n){const{ItemsService:e}=this.services;return new e(n,{accountability:null,knex:this.database,schema:this.schema})}};var o=class n{static TABLENAME="auto_backup_settings";constructor(n,e,t){this.database=e,this.itemsServiceCreator=new l(n,e,t)}async init(){this.translationSettingsService=await this.itemsServiceCreator.getItemsService(n.TABLENAME)}async setSettings(n){let e=await this.getSettings();e&&e?.id&&await this.translationSettingsService.updateOne(e?.id,n)}async getActiveStatus(){return(await this.getSettings())?.active}async getState(){return(await this.getSettings())?.state}async getDBClient(){return(await this.getSettings())?.DB_CLIENT||"sqlite3"}isSQLITE3DBClient(n){return"sqlite3"===n}async getBackupLocationType(){return(await this.getSettings())?.backup_location_type||"file_library"}isBackupLocationTypeFileLibrary(n){return"file_library"===n}async getBackupLocationFileLibraryFolderName(){return(await this.getSettings())?.backup_location_folder_name||"backups"}async setBackupLocationFileLibraryFolderName(n){await this.setSettings({backup_location_folder_name:n})}async getBackupLocationFileLibraryFolderID(){return(await this.getSettings())?.backup_location_folder_id}async setBackupLocationFileLibraryFolderID(n){await this.setSettings({backup_location_folder_id:n})}isBackupLocationTypeCustomPath(n){return"custom_path"===n}async getBackupLocationCustomPath(){return(await this.getSettings())?.backup_location_custom_path}async getSQLITE3DBFilename(){let n=(await this.getSettings())?.sqlite3_db_filename;return n||"/directus/database/data.db"}async setCurrentState(n){await this.setSettings({state:n})}async setLatestLog(n){await this.setSettings({latest_log:n})}async getSettings(){let n=await this.translationSettingsService.readByQuery({});return n&&n.length>0?n[0]:null}async isAutoBackupEnabled(){return(await this.getSettings())?.active}},s={},r={},u={};function c(n){return null==n}function p(n,e){var t="",i=n.reason||"(unknown reason)";return n.mark?(n.mark.name&&(t+='in "'+n.mark.name+'" '),t+="("+(n.mark.line+1)+":"+(n.mark.column+1)+")",!e&&n.mark.snippet&&(t+="\n\n"+n.mark.snippet),i+" "+t):i}function d(n,e){Error.call(this),this.name="YAMLException",this.reason=n,this.mark=e,this.message=p(this,!1),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=(new Error).stack||""}u.isNothing=c,u.isObject=function(n){return"object"==typeof n&&null!==n},u.toArray=function(n){return Array.isArray(n)?n:c(n)?[]:[n]},u.repeat=function(n,e){var t,i="";for(t=0;t<e;t+=1)i+=n;return i},u.isNegativeZero=function(n){return 0===n&&Number.NEGATIVE_INFINITY===1/n},u.extend=function(n,e){var t,i,a,l;if(e)for(t=0,i=(l=Object.keys(e)).length;t<i;t+=1)n[a=l[t]]=e[a];return n},d.prototype=Object.create(Error.prototype),d.prototype.constructor=d,d.prototype.toString=function(n){return this.name+": "+p(this,n)};var f=d,h=u;function _(n,e,t,i,a){var l="",o="",s=Math.floor(a/2)-1;return i-e>s&&(e=i-s+(l=" ... ").length),t-i>s&&(t=i+s-(o=" ...").length),{str:l+n.slice(e,t).replace(/\t/g,"â†’")+o,pos:i-e+l.length}}function g(n,e){return h.repeat(" ",e-n.length)+n}var m=function(n,e){if(e=Object.create(e||null),!n.buffer)return null;e.maxLength||(e.maxLength=79),"number"!=typeof e.indent&&(e.indent=1),"number"!=typeof e.linesBefore&&(e.linesBefore=3),"number"!=typeof e.linesAfter&&(e.linesAfter=2);for(var t,i=/\r?\n|\r|\0/g,a=[0],l=[],o=-1;t=i.exec(n.buffer);)l.push(t.index),a.push(t.index+t[0].length),n.position<=t.index&&o<0&&(o=a.length-2);o<0&&(o=a.length-1);var s,r,u="",c=Math.min(n.line+e.linesAfter,l.length).toString().length,p=e.maxLength-(e.indent+c+3);for(s=1;s<=e.linesBefore&&!(o-s<0);s++)r=_(n.buffer,a[o-s],l[o-s],n.position-(a[o]-a[o-s]),p),u=h.repeat(" ",e.indent)+g((n.line-s+1).toString(),c)+" | "+r.str+"\n"+u;for(r=_(n.buffer,a[o],l[o],n.position,p),u+=h.repeat(" ",e.indent)+g((n.line+1).toString(),c)+" | "+r.str+"\n",u+=h.repeat("-",e.indent+c+3+r.pos)+"^\n",s=1;s<=e.linesAfter&&!(o+s>=l.length);s++)r=_(n.buffer,a[o+s],l[o+s],n.position-(a[o]-a[o+s]),p),u+=h.repeat(" ",e.indent)+g((n.line+s+1).toString(),c)+" | "+r.str+"\n";return u.replace(/\n$/,"")},y=f,b=["kind","multi","resolve","construct","instanceOf","predicate","represent","representName","defaultStyle","styleAliases"],k=["scalar","sequence","mapping"];var v=function(n,e){if(e=e||{},Object.keys(e).forEach((function(e){if(-1===b.indexOf(e))throw new y('Unknown option "'+e+'" is met in definition of "'+n+'" YAML type.')})),this.options=e,this.tag=n,this.kind=e.kind||null,this.resolve=e.resolve||function(){return!0},this.construct=e.construct||function(n){return n},this.instanceOf=e.instanceOf||null,this.predicate=e.predicate||null,this.represent=e.represent||null,this.representName=e.representName||null,this.defaultStyle=e.defaultStyle||null,this.multi=e.multi||!1,this.styleAliases=function(n){var e={};return null!==n&&Object.keys(n).forEach((function(t){n[t].forEach((function(n){e[String(n)]=t}))})),e}(e.styleAliases||null),-1===k.indexOf(this.kind))throw new y('Unknown kind "'+this.kind+'" is specified for "'+n+'" YAML type.')},w=f,A=v;function S(n,e){var t=[];return n[e].forEach((function(n){var e=t.length;t.forEach((function(t,i){t.tag===n.tag&&t.kind===n.kind&&t.multi===n.multi&&(e=i)})),t[e]=n})),t}function x(n){return this.extend(n)}x.prototype.extend=function(n){var e=[],t=[];if(n instanceof A)t.push(n);else if(Array.isArray(n))t=t.concat(n);else{if(!n||!Array.isArray(n.implicit)&&!Array.isArray(n.explicit))throw new w("Schema.extend argument should be a Type, [ Type ], or a schema definition ({ implicit: [...], explicit: [...] })");n.implicit&&(e=e.concat(n.implicit)),n.explicit&&(t=t.concat(n.explicit))}e.forEach((function(n){if(!(n instanceof A))throw new w("Specified list of YAML types (or a single Type object) contains a non-Type object.");if(n.loadKind&&"scalar"!==n.loadKind)throw new w("There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.");if(n.multi)throw new w("There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.")})),t.forEach((function(n){if(!(n instanceof A))throw new w("Specified list of YAML types (or a single Type object) contains a non-Type object.")}));var i=Object.create(x.prototype);return i.implicit=(this.implicit||[]).concat(e),i.explicit=(this.explicit||[]).concat(t),i.compiledImplicit=S(i,"implicit"),i.compiledExplicit=S(i,"explicit"),i.compiledTypeMap=function(){var n,e,t={scalar:{},sequence:{},mapping:{},fallback:{},multi:{scalar:[],sequence:[],mapping:[],fallback:[]}};function i(n){n.multi?(t.multi[n.kind].push(n),t.multi.fallback.push(n)):t[n.kind][n.tag]=t.fallback[n.tag]=n}for(n=0,e=arguments.length;n<e;n+=1)arguments[n].forEach(i);return t}(i.compiledImplicit,i.compiledExplicit),i};var C=x,L=new v("tag:yaml.org,2002:str",{kind:"scalar",construct:function(n){return null!==n?n:""}}),I=new v("tag:yaml.org,2002:seq",{kind:"sequence",construct:function(n){return null!==n?n:[]}}),T=new v("tag:yaml.org,2002:map",{kind:"mapping",construct:function(n){return null!==n?n:{}}}),F=new C({explicit:[L,I,T]});var N=new v("tag:yaml.org,2002:null",{kind:"scalar",resolve:function(n){if(null===n)return!0;var e=n.length;return 1===e&&"~"===n||4===e&&("null"===n||"Null"===n||"NULL"===n)},construct:function(){return null},predicate:function(n){return null===n},represent:{canonical:function(){return"~"},lowercase:function(){return"null"},uppercase:function(){return"NULL"},camelcase:function(){return"Null"},empty:function(){return""}},defaultStyle:"lowercase"});var E=new v("tag:yaml.org,2002:bool",{kind:"scalar",resolve:function(n){if(null===n)return!1;var e=n.length;return 4===e&&("true"===n||"True"===n||"TRUE"===n)||5===e&&("false"===n||"False"===n||"FALSE"===n)},construct:function(n){return"true"===n||"True"===n||"TRUE"===n},predicate:function(n){return"[object Boolean]"===Object.prototype.toString.call(n)},represent:{lowercase:function(n){return n?"true":"false"},uppercase:function(n){return n?"TRUE":"FALSE"},camelcase:function(n){return n?"True":"False"}},defaultStyle:"lowercase"}),O=u;function q(n){return 48<=n&&n<=55}function B(n){return 48<=n&&n<=57}var j=new v("tag:yaml.org,2002:int",{kind:"scalar",resolve:function(n){if(null===n)return!1;var e,t,i=n.length,a=0,l=!1;if(!i)return!1;if("-"!==(e=n[a])&&"+"!==e||(e=n[++a]),"0"===e){if(a+1===i)return!0;if("b"===(e=n[++a])){for(a++;a<i;a++)if("_"!==(e=n[a])){if("0"!==e&&"1"!==e)return!1;l=!0}return l&&"_"!==e}if("x"===e){for(a++;a<i;a++)if("_"!==(e=n[a])){if(!(48<=(t=n.charCodeAt(a))&&t<=57||65<=t&&t<=70||97<=t&&t<=102))return!1;l=!0}return l&&"_"!==e}if("o"===e){for(a++;a<i;a++)if("_"!==(e=n[a])){if(!q(n.charCodeAt(a)))return!1;l=!0}return l&&"_"!==e}}if("_"===e)return!1;for(;a<i;a++)if("_"!==(e=n[a])){if(!B(n.charCodeAt(a)))return!1;l=!0}return!(!l||"_"===e)},construct:function(n){var e,t=n,i=1;if(-1!==t.indexOf("_")&&(t=t.replace(/_/g,"")),"-"!==(e=t[0])&&"+"!==e||("-"===e&&(i=-1),e=(t=t.slice(1))[0]),"0"===t)return 0;if("0"===e){if("b"===t[1])return i*parseInt(t.slice(2),2);if("x"===t[1])return i*parseInt(t.slice(2),16);if("o"===t[1])return i*parseInt(t.slice(2),8)}return i*parseInt(t,10)},predicate:function(n){return"[object Number]"===Object.prototype.toString.call(n)&&n%1==0&&!O.isNegativeZero(n)},represent:{binary:function(n){return n>=0?"0b"+n.toString(2):"-0b"+n.toString(2).slice(1)},octal:function(n){return n>=0?"0o"+n.toString(8):"-0o"+n.toString(8).slice(1)},decimal:function(n){return n.toString(10)},hexadecimal:function(n){return n>=0?"0x"+n.toString(16).toUpperCase():"-0x"+n.toString(16).toUpperCase().slice(1)}},defaultStyle:"decimal",styleAliases:{binary:[2,"bin"],octal:[8,"oct"],decimal:[10,"dec"],hexadecimal:[16,"hex"]}}),M=u,D=v,U=new RegExp("^(?:[-+]?(?:[0-9][0-9_]*)(?:\\.[0-9_]*)?(?:[eE][-+]?[0-9]+)?|\\.[0-9_]+(?:[eE][-+]?[0-9]+)?|[-+]?\\.(?:inf|Inf|INF)|\\.(?:nan|NaN|NAN))$");var Y=/^[-+]?[0-9]+e/;var R=new D("tag:yaml.org,2002:float",{kind:"scalar",resolve:function(n){return null!==n&&!(!U.test(n)||"_"===n[n.length-1])},construct:function(n){var e,t;return t="-"===(e=n.replace(/_/g,"").toLowerCase())[0]?-1:1,"+-".indexOf(e[0])>=0&&(e=e.slice(1)),".inf"===e?1===t?Number.POSITIVE_INFINITY:Number.NEGATIVE_INFINITY:".nan"===e?NaN:t*parseFloat(e,10)},predicate:function(n){return"[object Number]"===Object.prototype.toString.call(n)&&(n%1!=0||M.isNegativeZero(n))},represent:function(n,e){var t;if(isNaN(n))switch(e){case"lowercase":return".nan";case"uppercase":return".NAN";case"camelcase":return".NaN"}else if(Number.POSITIVE_INFINITY===n)switch(e){case"lowercase":return".inf";case"uppercase":return".INF";case"camelcase":return".Inf"}else if(Number.NEGATIVE_INFINITY===n)switch(e){case"lowercase":return"-.inf";case"uppercase":return"-.INF";case"camelcase":return"-.Inf"}else if(M.isNegativeZero(n))return"-0.0";return t=n.toString(10),Y.test(t)?t.replace("e",".e"):t},defaultStyle:"lowercase"}),P=F.extend({implicit:[N,E,j,R]}),K=P,V=v,W=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9])-([0-9][0-9])$"),G=new RegExp("^([0-9][0-9][0-9][0-9])-([0-9][0-9]?)-([0-9][0-9]?)(?:[Tt]|[ \\t]+)([0-9][0-9]?):([0-9][0-9]):([0-9][0-9])(?:\\.([0-9]*))?(?:[ \\t]*(Z|([-+])([0-9][0-9]?)(?::([0-9][0-9]))?))?$");var H=new V("tag:yaml.org,2002:timestamp",{kind:"scalar",resolve:function(n){return null!==n&&(null!==W.exec(n)||null!==G.exec(n))},construct:function(n){var e,t,i,a,l,o,s,r,u=0,c=null;if(null===(e=W.exec(n))&&(e=G.exec(n)),null===e)throw new Error("Date resolve error");if(t=+e[1],i=+e[2]-1,a=+e[3],!e[4])return new Date(Date.UTC(t,i,a));if(l=+e[4],o=+e[5],s=+e[6],e[7]){for(u=e[7].slice(0,3);u.length<3;)u+="0";u=+u}return e[9]&&(c=6e4*(60*+e[10]+ +(e[11]||0)),"-"===e[9]&&(c=-c)),r=new Date(Date.UTC(t,i,a,l,o,s,u)),c&&r.setTime(r.getTime()-c),r},instanceOf:Date,represent:function(n){return n.toISOString()}});var Q=new v("tag:yaml.org,2002:merge",{kind:"scalar",resolve:function(n){return"<<"===n||null===n}}),$="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\n\r";var z=new v("tag:yaml.org,2002:binary",{kind:"scalar",resolve:function(n){if(null===n)return!1;var e,t,i=0,a=n.length,l=$;for(t=0;t<a;t++)if(!((e=l.indexOf(n.charAt(t)))>64)){if(e<0)return!1;i+=6}return i%8==0},construct:function(n){var e,t,i=n.replace(/[\r\n=]/g,""),a=i.length,l=$,o=0,s=[];for(e=0;e<a;e++)e%4==0&&e&&(s.push(o>>16&255),s.push(o>>8&255),s.push(255&o)),o=o<<6|l.indexOf(i.charAt(e));return 0===(t=a%4*6)?(s.push(o>>16&255),s.push(o>>8&255),s.push(255&o)):18===t?(s.push(o>>10&255),s.push(o>>2&255)):12===t&&s.push(o>>4&255),new Uint8Array(s)},predicate:function(n){return"[object Uint8Array]"===Object.prototype.toString.call(n)},represent:function(n){var e,t,i="",a=0,l=n.length,o=$;for(e=0;e<l;e++)e%3==0&&e&&(i+=o[a>>18&63],i+=o[a>>12&63],i+=o[a>>6&63],i+=o[63&a]),a=(a<<8)+n[e];return 0===(t=l%3)?(i+=o[a>>18&63],i+=o[a>>12&63],i+=o[a>>6&63],i+=o[63&a]):2===t?(i+=o[a>>10&63],i+=o[a>>4&63],i+=o[a<<2&63],i+=o[64]):1===t&&(i+=o[a>>2&63],i+=o[a<<4&63],i+=o[64],i+=o[64]),i}}),Z=v,J=Object.prototype.hasOwnProperty,X=Object.prototype.toString;var nn=new Z("tag:yaml.org,2002:omap",{kind:"sequence",resolve:function(n){if(null===n)return!0;var e,t,i,a,l,o=[],s=n;for(e=0,t=s.length;e<t;e+=1){if(i=s[e],l=!1,"[object Object]"!==X.call(i))return!1;for(a in i)if(J.call(i,a)){if(l)return!1;l=!0}if(!l)return!1;if(-1!==o.indexOf(a))return!1;o.push(a)}return!0},construct:function(n){return null!==n?n:[]}}),en=v,tn=Object.prototype.toString;var an=new en("tag:yaml.org,2002:pairs",{kind:"sequence",resolve:function(n){if(null===n)return!0;var e,t,i,a,l,o=n;for(l=new Array(o.length),e=0,t=o.length;e<t;e+=1){if(i=o[e],"[object Object]"!==tn.call(i))return!1;if(1!==(a=Object.keys(i)).length)return!1;l[e]=[a[0],i[a[0]]]}return!0},construct:function(n){if(null===n)return[];var e,t,i,a,l,o=n;for(l=new Array(o.length),e=0,t=o.length;e<t;e+=1)i=o[e],a=Object.keys(i),l[e]=[a[0],i[a[0]]];return l}}),ln=v,on=Object.prototype.hasOwnProperty;var sn=new ln("tag:yaml.org,2002:set",{kind:"mapping",resolve:function(n){if(null===n)return!0;var e,t=n;for(e in t)if(on.call(t,e)&&null!==t[e])return!1;return!0},construct:function(n){return null!==n?n:{}}}),rn=K.extend({implicit:[H,Q],explicit:[z,nn,an,sn]}),un=u,cn=f,pn=m,dn=rn,fn=Object.prototype.hasOwnProperty,hn=/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,_n=/[\x85\u2028\u2029]/,gn=/[,\[\]\{\}]/,mn=/^(?:!|!!|![a-z\-]+!)$/i,yn=/^(?:!|[^,\[\]\{\}])(?:%[0-9a-f]{2}|[0-9a-z\-#;\/\?:@&=\+\$,_\.!~\*'\(\)\[\]])*$/i;function bn(n){return Object.prototype.toString.call(n)}function kn(n){return 10===n||13===n}function vn(n){return 9===n||32===n}function wn(n){return 9===n||32===n||10===n||13===n}function An(n){return 44===n||91===n||93===n||123===n||125===n}function Sn(n){var e;return 48<=n&&n<=57?n-48:97<=(e=32|n)&&e<=102?e-97+10:-1}function xn(n){return 48===n?"\0":97===n?"":98===n?"\b":116===n||9===n?"\t":110===n?"\n":118===n?"\v":102===n?"\f":114===n?"\r":101===n?"":32===n?" ":34===n?'"':47===n?"/":92===n?"\\":78===n?"Â…":95===n?"Â ":76===n?"\u2028":80===n?"\u2029":""}function Cn(n){return n<=65535?String.fromCharCode(n):String.fromCharCode(55296+(n-65536>>10),56320+(n-65536&1023))}for(var Ln=new Array(256),In=new Array(256),Tn=0;Tn<256;Tn++)Ln[Tn]=xn(Tn)?1:0,In[Tn]=xn(Tn);function Fn(n,e){this.input=n,this.filename=e.filename||null,this.schema=e.schema||dn,this.onWarning=e.onWarning||null,this.legacy=e.legacy||!1,this.json=e.json||!1,this.listener=e.listener||null,this.implicitTypes=this.schema.compiledImplicit,this.typeMap=this.schema.compiledTypeMap,this.length=n.length,this.position=0,this.line=0,this.lineStart=0,this.lineIndent=0,this.firstTabInLine=-1,this.documents=[]}function Nn(n,e){var t={name:n.filename,buffer:n.input.slice(0,-1),position:n.position,line:n.line,column:n.position-n.lineStart};return t.snippet=pn(t),new cn(e,t)}function En(n,e){throw Nn(n,e)}function On(n,e){n.onWarning&&n.onWarning.call(null,Nn(n,e))}var qn={YAML:function(n,e,t){var i,a,l;null!==n.version&&En(n,"duplication of %YAML directive"),1!==t.length&&En(n,"YAML directive accepts exactly one argument"),null===(i=/^([0-9]+)\.([0-9]+)$/.exec(t[0]))&&En(n,"ill-formed argument of the YAML directive"),a=parseInt(i[1],10),l=parseInt(i[2],10),1!==a&&En(n,"unacceptable YAML version of the document"),n.version=t[0],n.checkLineBreaks=l<2,1!==l&&2!==l&&On(n,"unsupported YAML version of the document")},TAG:function(n,e,t){var i,a;2!==t.length&&En(n,"TAG directive accepts exactly two arguments"),i=t[0],a=t[1],mn.test(i)||En(n,"ill-formed tag handle (first argument) of the TAG directive"),fn.call(n.tagMap,i)&&En(n,'there is a previously declared suffix for "'+i+'" tag handle'),yn.test(a)||En(n,"ill-formed tag prefix (second argument) of the TAG directive");try{a=decodeURIComponent(a)}catch(e){En(n,"tag prefix is malformed: "+a)}n.tagMap[i]=a}};function Bn(n,e,t,i){var a,l,o,s;if(e<t){if(s=n.input.slice(e,t),i)for(a=0,l=s.length;a<l;a+=1)9===(o=s.charCodeAt(a))||32<=o&&o<=1114111||En(n,"expected valid JSON character");else hn.test(s)&&En(n,"the stream contains non-printable characters");n.result+=s}}function jn(n,e,t,i){var a,l,o,s;for(un.isObject(t)||En(n,"cannot merge mappings; the provided source object is unacceptable"),o=0,s=(a=Object.keys(t)).length;o<s;o+=1)l=a[o],fn.call(e,l)||(e[l]=t[l],i[l]=!0)}function Mn(n,e,t,i,a,l,o,s,r){var u,c;if(Array.isArray(a))for(u=0,c=(a=Array.prototype.slice.call(a)).length;u<c;u+=1)Array.isArray(a[u])&&En(n,"nested arrays are not supported inside keys"),"object"==typeof a&&"[object Object]"===bn(a[u])&&(a[u]="[object Object]");if("object"==typeof a&&"[object Object]"===bn(a)&&(a="[object Object]"),a=String(a),null===e&&(e={}),"tag:yaml.org,2002:merge"===i)if(Array.isArray(l))for(u=0,c=l.length;u<c;u+=1)jn(n,e,l[u],t);else jn(n,e,l,t);else n.json||fn.call(t,a)||!fn.call(e,a)||(n.line=o||n.line,n.lineStart=s||n.lineStart,n.position=r||n.position,En(n,"duplicated mapping key")),"__proto__"===a?Object.defineProperty(e,a,{configurable:!0,enumerable:!0,writable:!0,value:l}):e[a]=l,delete t[a];return e}function Dn(n){var e;10===(e=n.input.charCodeAt(n.position))?n.position++:13===e?(n.position++,10===n.input.charCodeAt(n.position)&&n.position++):En(n,"a line break is expected"),n.line+=1,n.lineStart=n.position,n.firstTabInLine=-1}function Un(n,e,t){for(var i=0,a=n.input.charCodeAt(n.position);0!==a;){for(;vn(a);)9===a&&-1===n.firstTabInLine&&(n.firstTabInLine=n.position),a=n.input.charCodeAt(++n.position);if(e&&35===a)do{a=n.input.charCodeAt(++n.position)}while(10!==a&&13!==a&&0!==a);if(!kn(a))break;for(Dn(n),a=n.input.charCodeAt(n.position),i++,n.lineIndent=0;32===a;)n.lineIndent++,a=n.input.charCodeAt(++n.position)}return-1!==t&&0!==i&&n.lineIndent<t&&On(n,"deficient indentation"),i}function Yn(n){var e,t=n.position;return!(45!==(e=n.input.charCodeAt(t))&&46!==e||e!==n.input.charCodeAt(t+1)||e!==n.input.charCodeAt(t+2)||(t+=3,0!==(e=n.input.charCodeAt(t))&&!wn(e)))}function Rn(n,e){1===e?n.result+=" ":e>1&&(n.result+=un.repeat("\n",e-1))}function Pn(n,e){var t,i,a=n.tag,l=n.anchor,o=[],s=!1;if(-1!==n.firstTabInLine)return!1;for(null!==n.anchor&&(n.anchorMap[n.anchor]=o),i=n.input.charCodeAt(n.position);0!==i&&(-1!==n.firstTabInLine&&(n.position=n.firstTabInLine,En(n,"tab characters must not be used in indentation")),45===i)&&wn(n.input.charCodeAt(n.position+1));)if(s=!0,n.position++,Un(n,!0,-1)&&n.lineIndent<=e)o.push(null),i=n.input.charCodeAt(n.position);else if(t=n.line,Wn(n,e,3,!1,!0),o.push(n.result),Un(n,!0,-1),i=n.input.charCodeAt(n.position),(n.line===t||n.lineIndent>e)&&0!==i)En(n,"bad indentation of a sequence entry");else if(n.lineIndent<e)break;return!!s&&(n.tag=a,n.anchor=l,n.kind="sequence",n.result=o,!0)}function Kn(n){var e,t,i,a,l=!1,o=!1;if(33!==(a=n.input.charCodeAt(n.position)))return!1;if(null!==n.tag&&En(n,"duplication of a tag property"),60===(a=n.input.charCodeAt(++n.position))?(l=!0,a=n.input.charCodeAt(++n.position)):33===a?(o=!0,t="!!",a=n.input.charCodeAt(++n.position)):t="!",e=n.position,l){do{a=n.input.charCodeAt(++n.position)}while(0!==a&&62!==a);n.position<n.length?(i=n.input.slice(e,n.position),a=n.input.charCodeAt(++n.position)):En(n,"unexpected end of the stream within a verbatim tag")}else{for(;0!==a&&!wn(a);)33===a&&(o?En(n,"tag suffix cannot contain exclamation marks"):(t=n.input.slice(e-1,n.position+1),mn.test(t)||En(n,"named tag handle cannot contain such characters"),o=!0,e=n.position+1)),a=n.input.charCodeAt(++n.position);i=n.input.slice(e,n.position),gn.test(i)&&En(n,"tag suffix cannot contain flow indicator characters")}i&&!yn.test(i)&&En(n,"tag name cannot contain such characters: "+i);try{i=decodeURIComponent(i)}catch(e){En(n,"tag name is malformed: "+i)}return l?n.tag=i:fn.call(n.tagMap,t)?n.tag=n.tagMap[t]+i:"!"===t?n.tag="!"+i:"!!"===t?n.tag="tag:yaml.org,2002:"+i:En(n,'undeclared tag handle "'+t+'"'),!0}function Vn(n){var e,t;if(38!==(t=n.input.charCodeAt(n.position)))return!1;for(null!==n.anchor&&En(n,"duplication of an anchor property"),t=n.input.charCodeAt(++n.position),e=n.position;0!==t&&!wn(t)&&!An(t);)t=n.input.charCodeAt(++n.position);return n.position===e&&En(n,"name of an anchor node must contain at least one character"),n.anchor=n.input.slice(e,n.position),!0}function Wn(n,e,t,i,a){var l,o,s,r,u,c,p,d,f,h=1,_=!1,g=!1;if(null!==n.listener&&n.listener("open",n),n.tag=null,n.anchor=null,n.kind=null,n.result=null,l=o=s=4===t||3===t,i&&Un(n,!0,-1)&&(_=!0,n.lineIndent>e?h=1:n.lineIndent===e?h=0:n.lineIndent<e&&(h=-1)),1===h)for(;Kn(n)||Vn(n);)Un(n,!0,-1)?(_=!0,s=l,n.lineIndent>e?h=1:n.lineIndent===e?h=0:n.lineIndent<e&&(h=-1)):s=!1;if(s&&(s=_||a),1!==h&&4!==t||(d=1===t||2===t?e:e+1,f=n.position-n.lineStart,1===h?s&&(Pn(n,f)||function(n,e,t){var i,a,l,o,s,r,u,c=n.tag,p=n.anchor,d={},f=Object.create(null),h=null,_=null,g=null,m=!1,y=!1;if(-1!==n.firstTabInLine)return!1;for(null!==n.anchor&&(n.anchorMap[n.anchor]=d),u=n.input.charCodeAt(n.position);0!==u;){if(m||-1===n.firstTabInLine||(n.position=n.firstTabInLine,En(n,"tab characters must not be used in indentation")),i=n.input.charCodeAt(n.position+1),l=n.line,63!==u&&58!==u||!wn(i)){if(o=n.line,s=n.lineStart,r=n.position,!Wn(n,t,2,!1,!0))break;if(n.line===l){for(u=n.input.charCodeAt(n.position);vn(u);)u=n.input.charCodeAt(++n.position);if(58===u)wn(u=n.input.charCodeAt(++n.position))||En(n,"a whitespace character is expected after the key-value separator within a block mapping"),m&&(Mn(n,d,f,h,_,null,o,s,r),h=_=g=null),y=!0,m=!1,a=!1,h=n.tag,_=n.result;else{if(!y)return n.tag=c,n.anchor=p,!0;En(n,"can not read an implicit mapping pair; a colon is missed")}}else{if(!y)return n.tag=c,n.anchor=p,!0;En(n,"can not read a block mapping entry; a multiline key may not be an implicit key")}}else 63===u?(m&&(Mn(n,d,f,h,_,null,o,s,r),h=_=g=null),y=!0,m=!0,a=!0):m?(m=!1,a=!0):En(n,"incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line"),n.position+=1,u=i;if((n.line===l||n.lineIndent>e)&&(m&&(o=n.line,s=n.lineStart,r=n.position),Wn(n,e,4,!0,a)&&(m?_=n.result:g=n.result),m||(Mn(n,d,f,h,_,g,o,s,r),h=_=g=null),Un(n,!0,-1),u=n.input.charCodeAt(n.position)),(n.line===l||n.lineIndent>e)&&0!==u)En(n,"bad indentation of a mapping entry");else if(n.lineIndent<e)break}return m&&Mn(n,d,f,h,_,null,o,s,r),y&&(n.tag=c,n.anchor=p,n.kind="mapping",n.result=d),y}(n,f,d))||function(n,e){var t,i,a,l,o,s,r,u,c,p,d,f,h=!0,_=n.tag,g=n.anchor,m=Object.create(null);if(91===(f=n.input.charCodeAt(n.position)))o=93,u=!1,l=[];else{if(123!==f)return!1;o=125,u=!0,l={}}for(null!==n.anchor&&(n.anchorMap[n.anchor]=l),f=n.input.charCodeAt(++n.position);0!==f;){if(Un(n,!0,e),(f=n.input.charCodeAt(n.position))===o)return n.position++,n.tag=_,n.anchor=g,n.kind=u?"mapping":"sequence",n.result=l,!0;h?44===f&&En(n,"expected the node content, but found ','"):En(n,"missed comma between flow collection entries"),d=null,s=r=!1,63===f&&wn(n.input.charCodeAt(n.position+1))&&(s=r=!0,n.position++,Un(n,!0,e)),t=n.line,i=n.lineStart,a=n.position,Wn(n,e,1,!1,!0),p=n.tag,c=n.result,Un(n,!0,e),f=n.input.charCodeAt(n.position),!r&&n.line!==t||58!==f||(s=!0,f=n.input.charCodeAt(++n.position),Un(n,!0,e),Wn(n,e,1,!1,!0),d=n.result),u?Mn(n,l,m,p,c,d,t,i,a):s?l.push(Mn(n,null,m,p,c,d,t,i,a)):l.push(c),Un(n,!0,e),44===(f=n.input.charCodeAt(n.position))?(h=!0,f=n.input.charCodeAt(++n.position)):h=!1}En(n,"unexpected end of the stream within a flow collection")}(n,d)?g=!0:(o&&function(n,e){var t,i,a,l,o,s=1,r=!1,u=!1,c=e,p=0,d=!1;if(124===(l=n.input.charCodeAt(n.position)))i=!1;else{if(62!==l)return!1;i=!0}for(n.kind="scalar",n.result="";0!==l;)if(43===(l=n.input.charCodeAt(++n.position))||45===l)1===s?s=43===l?3:2:En(n,"repeat of a chomping mode identifier");else{if(!((a=48<=(o=l)&&o<=57?o-48:-1)>=0))break;0===a?En(n,"bad explicit indentation width of a block scalar; it cannot be less than one"):u?En(n,"repeat of an indentation width identifier"):(c=e+a-1,u=!0)}if(vn(l)){do{l=n.input.charCodeAt(++n.position)}while(vn(l));if(35===l)do{l=n.input.charCodeAt(++n.position)}while(!kn(l)&&0!==l)}for(;0!==l;){for(Dn(n),n.lineIndent=0,l=n.input.charCodeAt(n.position);(!u||n.lineIndent<c)&&32===l;)n.lineIndent++,l=n.input.charCodeAt(++n.position);if(!u&&n.lineIndent>c&&(c=n.lineIndent),kn(l))p++;else{if(n.lineIndent<c){3===s?n.result+=un.repeat("\n",r?1+p:p):1===s&&r&&(n.result+="\n");break}for(i?vn(l)?(d=!0,n.result+=un.repeat("\n",r?1+p:p)):d?(d=!1,n.result+=un.repeat("\n",p+1)):0===p?r&&(n.result+=" "):n.result+=un.repeat("\n",p):n.result+=un.repeat("\n",r?1+p:p),r=!0,u=!0,p=0,t=n.position;!kn(l)&&0!==l;)l=n.input.charCodeAt(++n.position);Bn(n,t,n.position,!1)}}return!0}(n,d)||function(n,e){var t,i,a;if(39!==(t=n.input.charCodeAt(n.position)))return!1;for(n.kind="scalar",n.result="",n.position++,i=a=n.position;0!==(t=n.input.charCodeAt(n.position));)if(39===t){if(Bn(n,i,n.position,!0),39!==(t=n.input.charCodeAt(++n.position)))return!0;i=n.position,n.position++,a=n.position}else kn(t)?(Bn(n,i,a,!0),Rn(n,Un(n,!1,e)),i=a=n.position):n.position===n.lineStart&&Yn(n)?En(n,"unexpected end of the document within a single quoted scalar"):(n.position++,a=n.position);En(n,"unexpected end of the stream within a single quoted scalar")}(n,d)||function(n,e){var t,i,a,l,o,s,r;if(34!==(s=n.input.charCodeAt(n.position)))return!1;for(n.kind="scalar",n.result="",n.position++,t=i=n.position;0!==(s=n.input.charCodeAt(n.position));){if(34===s)return Bn(n,t,n.position,!0),n.position++,!0;if(92===s){if(Bn(n,t,n.position,!0),kn(s=n.input.charCodeAt(++n.position)))Un(n,!1,e);else if(s<256&&Ln[s])n.result+=In[s],n.position++;else if((o=120===(r=s)?2:117===r?4:85===r?8:0)>0){for(a=o,l=0;a>0;a--)(o=Sn(s=n.input.charCodeAt(++n.position)))>=0?l=(l<<4)+o:En(n,"expected hexadecimal character");n.result+=Cn(l),n.position++}else En(n,"unknown escape sequence");t=i=n.position}else kn(s)?(Bn(n,t,i,!0),Rn(n,Un(n,!1,e)),t=i=n.position):n.position===n.lineStart&&Yn(n)?En(n,"unexpected end of the document within a double quoted scalar"):(n.position++,i=n.position)}En(n,"unexpected end of the stream within a double quoted scalar")}(n,d)?g=!0:!function(n){var e,t,i;if(42!==(i=n.input.charCodeAt(n.position)))return!1;for(i=n.input.charCodeAt(++n.position),e=n.position;0!==i&&!wn(i)&&!An(i);)i=n.input.charCodeAt(++n.position);return n.position===e&&En(n,"name of an alias node must contain at least one character"),t=n.input.slice(e,n.position),fn.call(n.anchorMap,t)||En(n,'unidentified alias "'+t+'"'),n.result=n.anchorMap[t],Un(n,!0,-1),!0}(n)?function(n,e,t){var i,a,l,o,s,r,u,c,p=n.kind,d=n.result;if(wn(c=n.input.charCodeAt(n.position))||An(c)||35===c||38===c||42===c||33===c||124===c||62===c||39===c||34===c||37===c||64===c||96===c)return!1;if((63===c||45===c)&&(wn(i=n.input.charCodeAt(n.position+1))||t&&An(i)))return!1;for(n.kind="scalar",n.result="",a=l=n.position,o=!1;0!==c;){if(58===c){if(wn(i=n.input.charCodeAt(n.position+1))||t&&An(i))break}else if(35===c){if(wn(n.input.charCodeAt(n.position-1)))break}else{if(n.position===n.lineStart&&Yn(n)||t&&An(c))break;if(kn(c)){if(s=n.line,r=n.lineStart,u=n.lineIndent,Un(n,!1,-1),n.lineIndent>=e){o=!0,c=n.input.charCodeAt(n.position);continue}n.position=l,n.line=s,n.lineStart=r,n.lineIndent=u;break}}o&&(Bn(n,a,l,!1),Rn(n,n.line-s),a=l=n.position,o=!1),vn(c)||(l=n.position+1),c=n.input.charCodeAt(++n.position)}return Bn(n,a,l,!1),!!n.result||(n.kind=p,n.result=d,!1)}(n,d,1===t)&&(g=!0,null===n.tag&&(n.tag="?")):(g=!0,null===n.tag&&null===n.anchor||En(n,"alias node should not have any properties")),null!==n.anchor&&(n.anchorMap[n.anchor]=n.result)):0===h&&(g=s&&Pn(n,f))),null===n.tag)null!==n.anchor&&(n.anchorMap[n.anchor]=n.result);else if("?"===n.tag){for(null!==n.result&&"scalar"!==n.kind&&En(n,'unacceptable node kind for !<?> tag; it should be "scalar", not "'+n.kind+'"'),r=0,u=n.implicitTypes.length;r<u;r+=1)if((p=n.implicitTypes[r]).resolve(n.result)){n.result=p.construct(n.result),n.tag=p.tag,null!==n.anchor&&(n.anchorMap[n.anchor]=n.result);break}}else if("!"!==n.tag){if(fn.call(n.typeMap[n.kind||"fallback"],n.tag))p=n.typeMap[n.kind||"fallback"][n.tag];else for(p=null,r=0,u=(c=n.typeMap.multi[n.kind||"fallback"]).length;r<u;r+=1)if(n.tag.slice(0,c[r].tag.length)===c[r].tag){p=c[r];break}p||En(n,"unknown tag !<"+n.tag+">"),null!==n.result&&p.kind!==n.kind&&En(n,"unacceptable node kind for !<"+n.tag+'> tag; it should be "'+p.kind+'", not "'+n.kind+'"'),p.resolve(n.result,n.tag)?(n.result=p.construct(n.result,n.tag),null!==n.anchor&&(n.anchorMap[n.anchor]=n.result)):En(n,"cannot resolve a node with !<"+n.tag+"> explicit tag")}return null!==n.listener&&n.listener("close",n),null!==n.tag||null!==n.anchor||g}function Gn(n){var e,t,i,a,l=n.position,o=!1;for(n.version=null,n.checkLineBreaks=n.legacy,n.tagMap=Object.create(null),n.anchorMap=Object.create(null);0!==(a=n.input.charCodeAt(n.position))&&(Un(n,!0,-1),a=n.input.charCodeAt(n.position),!(n.lineIndent>0||37!==a));){for(o=!0,a=n.input.charCodeAt(++n.position),e=n.position;0!==a&&!wn(a);)a=n.input.charCodeAt(++n.position);for(i=[],(t=n.input.slice(e,n.position)).length<1&&En(n,"directive name must not be less than one character in length");0!==a;){for(;vn(a);)a=n.input.charCodeAt(++n.position);if(35===a){do{a=n.input.charCodeAt(++n.position)}while(0!==a&&!kn(a));break}if(kn(a))break;for(e=n.position;0!==a&&!wn(a);)a=n.input.charCodeAt(++n.position);i.push(n.input.slice(e,n.position))}0!==a&&Dn(n),fn.call(qn,t)?qn[t](n,t,i):On(n,'unknown document directive "'+t+'"')}Un(n,!0,-1),0===n.lineIndent&&45===n.input.charCodeAt(n.position)&&45===n.input.charCodeAt(n.position+1)&&45===n.input.charCodeAt(n.position+2)?(n.position+=3,Un(n,!0,-1)):o&&En(n,"directives end mark is expected"),Wn(n,n.lineIndent-1,4,!1,!0),Un(n,!0,-1),n.checkLineBreaks&&_n.test(n.input.slice(l,n.position))&&On(n,"non-ASCII line breaks are interpreted as content"),n.documents.push(n.result),n.position===n.lineStart&&Yn(n)?46===n.input.charCodeAt(n.position)&&(n.position+=3,Un(n,!0,-1)):n.position<n.length-1&&En(n,"end of the stream or a document separator is expected")}function Hn(n,e){e=e||{},0!==(n=String(n)).length&&(10!==n.charCodeAt(n.length-1)&&13!==n.charCodeAt(n.length-1)&&(n+="\n"),65279===n.charCodeAt(0)&&(n=n.slice(1)));var t=new Fn(n,e),i=n.indexOf("\0");for(-1!==i&&(t.position=i,En(t,"null byte is not allowed in input")),t.input+="\0";32===t.input.charCodeAt(t.position);)t.lineIndent+=1,t.position+=1;for(;t.position<t.length-1;)Gn(t);return t.documents}r.loadAll=function(n,e,t){null!==e&&"object"==typeof e&&void 0===t&&(t=e,e=null);var i=Hn(n,t);if("function"!=typeof e)return i;for(var a=0,l=i.length;a<l;a+=1)e(i[a])},r.load=function(n,e){var t=Hn(n,e);if(0!==t.length){if(1===t.length)return t[0];throw new cn("expected a single document in the stream, but found more")}};var Qn={},$n=u,zn=f,Zn=rn,Jn=Object.prototype.toString,Xn=Object.prototype.hasOwnProperty,ne={0:"\\0",7:"\\a",8:"\\b",9:"\\t",10:"\\n",11:"\\v",12:"\\f",13:"\\r",27:"\\e",34:'\\"',92:"\\\\",133:"\\N",160:"\\_",8232:"\\L",8233:"\\P"},ee=["y","Y","yes","Yes","YES","on","On","ON","n","N","no","No","NO","off","Off","OFF"],te=/^[-+]?[0-9_]+(?::[0-9_]+)+(?:\.[0-9_]*)?$/;function ie(n){var e,t,i;if(e=n.toString(16).toUpperCase(),n<=255)t="x",i=2;else if(n<=65535)t="u",i=4;else{if(!(n<=4294967295))throw new zn("code point within a string may not be greater than 0xFFFFFFFF");t="U",i=8}return"\\"+t+$n.repeat("0",i-e.length)+e}function ae(n){this.schema=n.schema||Zn,this.indent=Math.max(1,n.indent||2),this.noArrayIndent=n.noArrayIndent||!1,this.skipInvalid=n.skipInvalid||!1,this.flowLevel=$n.isNothing(n.flowLevel)?-1:n.flowLevel,this.styleMap=function(n,e){var t,i,a,l,o,s,r;if(null===e)return{};for(t={},a=0,l=(i=Object.keys(e)).length;a<l;a+=1)o=i[a],s=String(e[o]),"!!"===o.slice(0,2)&&(o="tag:yaml.org,2002:"+o.slice(2)),(r=n.compiledTypeMap.fallback[o])&&Xn.call(r.styleAliases,s)&&(s=r.styleAliases[s]),t[o]=s;return t}(this.schema,n.styles||null),this.sortKeys=n.sortKeys||!1,this.lineWidth=n.lineWidth||80,this.noRefs=n.noRefs||!1,this.noCompatMode=n.noCompatMode||!1,this.condenseFlow=n.condenseFlow||!1,this.quotingType='"'===n.quotingType?2:1,this.forceQuotes=n.forceQuotes||!1,this.replacer="function"==typeof n.replacer?n.replacer:null,this.implicitTypes=this.schema.compiledImplicit,this.explicitTypes=this.schema.compiledExplicit,this.tag=null,this.result="",this.duplicates=[],this.usedDuplicates=null}function le(n,e){for(var t,i=$n.repeat(" ",e),a=0,l=-1,o="",s=n.length;a<s;)-1===(l=n.indexOf("\n",a))?(t=n.slice(a),a=s):(t=n.slice(a,l+1),a=l+1),t.length&&"\n"!==t&&(o+=i),o+=t;return o}function oe(n,e){return"\n"+$n.repeat(" ",n.indent*e)}function se(n){return 32===n||9===n}function re(n){return 32<=n&&n<=126||161<=n&&n<=55295&&8232!==n&&8233!==n||57344<=n&&n<=65533&&65279!==n||65536<=n&&n<=1114111}function ue(n){return re(n)&&65279!==n&&13!==n&&10!==n}function ce(n,e,t){var i=ue(n),a=i&&!se(n);return(t?i:i&&44!==n&&91!==n&&93!==n&&123!==n&&125!==n)&&35!==n&&!(58===e&&!a)||ue(e)&&!se(e)&&35===n||58===e&&a}function pe(n,e){var t,i=n.charCodeAt(e);return i>=55296&&i<=56319&&e+1<n.length&&(t=n.charCodeAt(e+1))>=56320&&t<=57343?1024*(i-55296)+t-56320+65536:i}function de(n){return/^\n* /.test(n)}function fe(n,e,t,i,a,l,o,s){var r,u,c=0,p=null,d=!1,f=!1,h=-1!==i,_=-1,g=re(u=pe(n,0))&&65279!==u&&!se(u)&&45!==u&&63!==u&&58!==u&&44!==u&&91!==u&&93!==u&&123!==u&&125!==u&&35!==u&&38!==u&&42!==u&&33!==u&&124!==u&&61!==u&&62!==u&&39!==u&&34!==u&&37!==u&&64!==u&&96!==u&&function(n){return!se(n)&&58!==n}(pe(n,n.length-1));if(e||o)for(r=0;r<n.length;c>=65536?r+=2:r++){if(!re(c=pe(n,r)))return 5;g=g&&ce(c,p,s),p=c}else{for(r=0;r<n.length;c>=65536?r+=2:r++){if(10===(c=pe(n,r)))d=!0,h&&(f=f||r-_-1>i&&" "!==n[_+1],_=r);else if(!re(c))return 5;g=g&&ce(c,p,s),p=c}f=f||h&&r-_-1>i&&" "!==n[_+1]}return d||f?t>9&&de(n)?5:o?2===l?5:2:f?4:3:!g||o||a(n)?2===l?5:2:1}function he(n,e,t,i,a){n.dump=function(){if(0===e.length)return 2===n.quotingType?'""':"''";if(!n.noCompatMode&&(-1!==ee.indexOf(e)||te.test(e)))return 2===n.quotingType?'"'+e+'"':"'"+e+"'";var l=n.indent*Math.max(1,t),o=-1===n.lineWidth?-1:Math.max(Math.min(n.lineWidth,40),n.lineWidth-l),s=i||n.flowLevel>-1&&t>=n.flowLevel;switch(fe(e,s,n.indent,o,(function(e){return function(n,e){var t,i;for(t=0,i=n.implicitTypes.length;t<i;t+=1)if(n.implicitTypes[t].resolve(e))return!0;return!1}(n,e)}),n.quotingType,n.forceQuotes&&!i,a)){case 1:return e;case 2:return"'"+e.replace(/'/g,"''")+"'";case 3:return"|"+_e(e,n.indent)+ge(le(e,l));case 4:return">"+_e(e,n.indent)+ge(le(function(n,e){var t,i,a=/(\n+)([^\n]*)/g,l=(s=n.indexOf("\n"),s=-1!==s?s:n.length,a.lastIndex=s,me(n.slice(0,s),e)),o="\n"===n[0]||" "===n[0];var s;for(;i=a.exec(n);){var r=i[1],u=i[2];t=" "===u[0],l+=r+(o||t||""===u?"":"\n")+me(u,e),o=t}return l}(e,o),l));case 5:return'"'+function(n){for(var e,t="",i=0,a=0;a<n.length;i>=65536?a+=2:a++)i=pe(n,a),!(e=ne[i])&&re(i)?(t+=n[a],i>=65536&&(t+=n[a+1])):t+=e||ie(i);return t}(e)+'"';default:throw new zn("impossible error: invalid scalar style")}}()}function _e(n,e){var t=de(n)?String(e):"",i="\n"===n[n.length-1];return t+(i&&("\n"===n[n.length-2]||"\n"===n)?"+":i?"":"-")+"\n"}function ge(n){return"\n"===n[n.length-1]?n.slice(0,-1):n}function me(n,e){if(""===n||" "===n[0])return n;for(var t,i,a=/ [^ ]/g,l=0,o=0,s=0,r="";t=a.exec(n);)(s=t.index)-l>e&&(i=o>l?o:s,r+="\n"+n.slice(l,i),l=i+1),o=s;return r+="\n",n.length-l>e&&o>l?r+=n.slice(l,o)+"\n"+n.slice(o+1):r+=n.slice(l),r.slice(1)}function ye(n,e,t,i){var a,l,o,s="",r=n.tag;for(a=0,l=t.length;a<l;a+=1)o=t[a],n.replacer&&(o=n.replacer.call(t,String(a),o)),(ke(n,e+1,o,!0,!0,!1,!0)||void 0===o&&ke(n,e+1,null,!0,!0,!1,!0))&&(i&&""===s||(s+=oe(n,e)),n.dump&&10===n.dump.charCodeAt(0)?s+="-":s+="- ",s+=n.dump);n.tag=r,n.dump=s||"[]"}function be(n,e,t){var i,a,l,o,s,r;for(l=0,o=(a=t?n.explicitTypes:n.implicitTypes).length;l<o;l+=1)if(((s=a[l]).instanceOf||s.predicate)&&(!s.instanceOf||"object"==typeof e&&e instanceof s.instanceOf)&&(!s.predicate||s.predicate(e))){if(t?s.multi&&s.representName?n.tag=s.representName(e):n.tag=s.tag:n.tag="?",s.represent){if(r=n.styleMap[s.tag]||s.defaultStyle,"[object Function]"===Jn.call(s.represent))i=s.represent(e,r);else{if(!Xn.call(s.represent,r))throw new zn("!<"+s.tag+'> tag resolver accepts not "'+r+'" style');i=s.represent[r](e,r)}n.dump=i}return!0}return!1}function ke(n,e,t,i,a,l,o){n.tag=null,n.dump=t,be(n,t,!1)||be(n,t,!0);var s,r=Jn.call(n.dump),u=i;i&&(i=n.flowLevel<0||n.flowLevel>e);var c,p,d="[object Object]"===r||"[object Array]"===r;if(d&&(p=-1!==(c=n.duplicates.indexOf(t))),(null!==n.tag&&"?"!==n.tag||p||2!==n.indent&&e>0)&&(a=!1),p&&n.usedDuplicates[c])n.dump="*ref_"+c;else{if(d&&p&&!n.usedDuplicates[c]&&(n.usedDuplicates[c]=!0),"[object Object]"===r)i&&0!==Object.keys(n.dump).length?(!function(n,e,t,i){var a,l,o,s,r,u,c="",p=n.tag,d=Object.keys(t);if(!0===n.sortKeys)d.sort();else if("function"==typeof n.sortKeys)d.sort(n.sortKeys);else if(n.sortKeys)throw new zn("sortKeys must be a boolean or a function");for(a=0,l=d.length;a<l;a+=1)u="",i&&""===c||(u+=oe(n,e)),s=t[o=d[a]],n.replacer&&(s=n.replacer.call(t,o,s)),ke(n,e+1,o,!0,!0,!0)&&((r=null!==n.tag&&"?"!==n.tag||n.dump&&n.dump.length>1024)&&(n.dump&&10===n.dump.charCodeAt(0)?u+="?":u+="? "),u+=n.dump,r&&(u+=oe(n,e)),ke(n,e+1,s,!0,r)&&(n.dump&&10===n.dump.charCodeAt(0)?u+=":":u+=": ",c+=u+=n.dump));n.tag=p,n.dump=c||"{}"}(n,e,n.dump,a),p&&(n.dump="&ref_"+c+n.dump)):(!function(n,e,t){var i,a,l,o,s,r="",u=n.tag,c=Object.keys(t);for(i=0,a=c.length;i<a;i+=1)s="",""!==r&&(s+=", "),n.condenseFlow&&(s+='"'),o=t[l=c[i]],n.replacer&&(o=n.replacer.call(t,l,o)),ke(n,e,l,!1,!1)&&(n.dump.length>1024&&(s+="? "),s+=n.dump+(n.condenseFlow?'"':"")+":"+(n.condenseFlow?"":" "),ke(n,e,o,!1,!1)&&(r+=s+=n.dump));n.tag=u,n.dump="{"+r+"}"}(n,e,n.dump),p&&(n.dump="&ref_"+c+" "+n.dump));else if("[object Array]"===r)i&&0!==n.dump.length?(n.noArrayIndent&&!o&&e>0?ye(n,e-1,n.dump,a):ye(n,e,n.dump,a),p&&(n.dump="&ref_"+c+n.dump)):(!function(n,e,t){var i,a,l,o="",s=n.tag;for(i=0,a=t.length;i<a;i+=1)l=t[i],n.replacer&&(l=n.replacer.call(t,String(i),l)),(ke(n,e,l,!1,!1)||void 0===l&&ke(n,e,null,!1,!1))&&(""!==o&&(o+=","+(n.condenseFlow?"":" ")),o+=n.dump);n.tag=s,n.dump="["+o+"]"}(n,e,n.dump),p&&(n.dump="&ref_"+c+" "+n.dump));else{if("[object String]"!==r){if("[object Undefined]"===r)return!1;if(n.skipInvalid)return!1;throw new zn("unacceptable kind of an object to dump "+r)}"?"!==n.tag&&he(n,n.dump,e,l,u)}null!==n.tag&&"?"!==n.tag&&(s=encodeURI("!"===n.tag[0]?n.tag.slice(1):n.tag).replace(/!/g,"%21"),s="!"===n.tag[0]?"!"+s:"tag:yaml.org,2002:"===s.slice(0,18)?"!!"+s.slice(18):"!<"+s+">",n.dump=s+" "+n.dump)}return!0}function ve(n,e){var t,i,a=[],l=[];for(we(n,a,l),t=0,i=l.length;t<i;t+=1)e.duplicates.push(a[l[t]]);e.usedDuplicates=new Array(i)}function we(n,e,t){var i,a,l;if(null!==n&&"object"==typeof n)if(-1!==(a=e.indexOf(n)))-1===t.indexOf(a)&&t.push(a);else if(e.push(n),Array.isArray(n))for(a=0,l=n.length;a<l;a+=1)we(n[a],e,t);else for(a=0,l=(i=Object.keys(n)).length;a<l;a+=1)we(n[i[a]],e,t)}Qn.dump=function(n,e){var t=new ae(e=e||{});t.noRefs||ve(n,t);var i=n;return t.replacer&&(i=t.replacer.call({"":i},"",i)),ke(t,0,i,!0,!0)?t.dump+"\n":""};var Ae=r,Se=Qn;function xe(n,e){return function(){throw new Error("Function yaml."+n+" is removed in js-yaml 4. Use yaml."+e+" instead, which is now safe by default.")}}s.Type=v,s.Schema=C,s.FAILSAFE_SCHEMA=F,s.JSON_SCHEMA=P,s.CORE_SCHEMA=K,s.DEFAULT_SCHEMA=rn,s.load=Ae.load,s.loadAll=Ae.loadAll,s.dump=Se.dump,s.YAMLException=f,s.types={binary:z,float:R,map:T,null:N,pairs:an,set:sn,timestamp:H,bool:E,int:j,merge:Q,omap:nn,seq:I,str:L},s.safeLoad=xe("safeLoad","load"),s.safeLoadAll=xe("safeLoadAll","loadAll"),s.safeDump=xe("safeDump","dump");const Ce=i.default,Le=a.default;const Ie=o,Te=class{constructor(n,e,t,i,a,l){this.database=i,this.backupController=n,this.backupSettings=e,this.services=t,this.schema=a,this.logFunc=l}async init(){}async getDirectusDatabasePath(){let n=await this.backupController.getDirectusRootFolderPath(),e=await this.backupSettings.getSQLITE3DBFilename();return Le.join(n,e)}async log(n,e){await this.logFunc(n,e)}async createBackup(n){let e="";e=await this.log(e,"Start backup");let t=await this.getDirectusDatabasePath(),i=Le.join(n,"backup.db");e=await this.log(e,"copy from: "+t),e=await this.log(e,"copy to: "+i);try{Ce.copyFileSync(t,i)}catch(n){return console.log(n),null}return e=await this.log(e,"Finished backup"),i}},Fe=i.default,Ne=a.default,Ee=process.env;const Oe=class{constructor(n,e,t){this.services=n,this.database=e,this.schema=t}getCollectionsService(){const{CollectionsService:n}=this.services;return new n({accountability:null,knex:this.database,schema:this.schema})}},qe=o,Be=function(){return"version: 1\ndirectus: 9.18.1\ncollections:\n  - collection: auto_backup_settings\n    meta:\n      accountability: all\n      archive_app_filter: true\n      archive_field: null\n      archive_value: archived\n      collapse: open\n      collection: auto_backup_settings\n      color: null\n      display_template: null\n      group: null\n      hidden: false\n      icon: null\n      item_duplication_fields: null\n      note: null\n      singleton: true\n      sort: null\n      sort_field: null\n      translations: null\n      unarchive_value: draft\n    schema:\n      name: auto_backup_settings\n      sql: >-\n        CREATE TABLE \"auto_backup_settings\" (`id` integer PRIMARY KEY\n        AUTOINCREMENT NOT NULL, `user_created` char(36) NULL, `date_created`\n        datetime NULL, `user_updated` char(36) NULL, `date_updated` datetime\n        NULL, `DB_CLIENT` varchar(255) NULL, `state` varchar(255) NULL DEFAULT\n        'finished', `active` boolean NULL DEFAULT '0', `latest_log` text NULL,\n        `sqlite3_db_filename` varchar(255) NULL DEFAULT\n        '/directus/database/data.db', `backup_location_type` varchar(255) NULL\n        DEFAULT 'file_library', `backup_location_folder_name` char(36) NULL\n        DEFAULT 'backups', `backup_location_folder_id` char(36) NULL DEFAULT\n        null, `backup_file_format` varchar(255) NULL DEFAULT\n        'YYYY-MM-DD-HH-mm-ss-SSS', `backup_location_custom_path` char(36) NULL\n        DEFAULT '/directus/database/backups', CONSTRAINT\n        `auto_backup_settings_user_created_foreign` FOREIGN KEY (`user_created`)\n        REFERENCES `directus_users` (`id`), CONSTRAINT\n        `auto_backup_settings_user_updated_foreign` FOREIGN KEY (`user_updated`)\n        REFERENCES `directus_users` (`id`))\nfields:\n  - collection: auto_backup_settings\n    field: DB_CLIENT\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: DB_CLIENT\n      group: general_settings\n      hidden: false\n      interface: select-dropdown\n      note: null\n      options:\n        allowNone: true\n        choices:\n          - text: sqlite3\n            value: sqlite3\n      readonly: false\n      required: false\n      sort: 7\n      special: null\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: varchar\n      default_value: null\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 255\n      name: DB_CLIENT\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: string\n  - collection: auto_backup_settings\n    field: active\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: active\n      group: null\n      hidden: false\n      interface: boolean\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 8\n      special:\n        - cast-boolean\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: boolean\n      default_value: false\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: null\n      name: active\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: boolean\n  - collection: auto_backup_settings\n    field: backup_file_format\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: backup_file_format\n      group: driver_specific_settings\n      hidden: false\n      interface: input\n      note: >-\n        The default timestamp format will be: YYYY-MM-DD-HH-mm-ss-SSS e. G.\n        2022-09-28-13-45-58-1234. Customize by using moment.js formats.\n      options: null\n      readonly: false\n      required: false\n      sort: 1\n      special: null\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: varchar\n      default_value: YYYY-MM-DD-HH-mm-ss-SSS\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 255\n      name: backup_file_format\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: string\n  - collection: auto_backup_settings\n    field: backup_location_custom_path\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: backup_location_custom_path\n      group: backup_location_type_custom\n      hidden: false\n      interface: input\n      note: 'Folder name (default: /directus/database/backups)'\n      options: null\n      readonly: false\n      required: false\n      sort: 1\n      special:\n        - file\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: char\n      default_value: /directus/database/backups\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 36\n      name: backup_location_custom_path\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: uuid\n  - collection: auto_backup_settings\n    field: backup_location_folder_id\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: backup_location_folder_id\n      group: backup_location_type_file_library\n      hidden: false\n      interface: input\n      note: 'Optional: ID of the folder'\n      options: null\n      readonly: false\n      required: false\n      sort: 3\n      special:\n        - file\n      translations: null\n      validation: null\n      validation_message: null\n      width: half\n    schema:\n      data_type: char\n      default_value: null\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 36\n      name: backup_location_folder_id\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: uuid\n  - collection: auto_backup_settings\n    field: backup_location_folder_name\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: backup_location_folder_name\n      group: backup_location_type_file_library\n      hidden: false\n      interface: input\n      note: 'Backup folder name (default: backups)'\n      options: null\n      readonly: false\n      required: false\n      sort: 1\n      special:\n        - file\n      translations: null\n      validation: null\n      validation_message: null\n      width: half\n    schema:\n      data_type: char\n      default_value: backups\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 36\n      name: backup_location_folder_name\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: uuid\n  - collection: auto_backup_settings\n    field: backup_location_type\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: backup_location_type\n      group: general_settings\n      hidden: false\n      interface: select-dropdown\n      note: Select how/where backups should be saved\n      options:\n        allowNone: true\n        choices:\n          - text: File Library\n            value: file_library\n          - text: Custom Path\n            value: custom_path\n      readonly: false\n      required: false\n      sort: 3\n      special: null\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: varchar\n      default_value: file_library\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 255\n      name: backup_location_type\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: string\n  - collection: auto_backup_settings\n    field: backup_location_type_custom\n    meta:\n      collection: auto_backup_settings\n      conditions:\n        - name: Visible\n          rule:\n            _and:\n              - backup_location_type:\n                  _neq: custom_path\n          options: {}\n          hidden: true\n      display: null\n      display_options: null\n      field: backup_location_type_custom\n      group: general_settings\n      hidden: false\n      interface: group-raw\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 4\n      special:\n        - alias\n        - group\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: backup_location_type_file_library\n    meta:\n      collection: auto_backup_settings\n      conditions:\n        - name: Vsisible\n          rule:\n            _and:\n              - backup_location_type:\n                  _neq: file_library\n          options: {}\n          hidden: true\n      display: null\n      display_options: null\n      field: backup_location_type_file_library\n      group: general_settings\n      hidden: false\n      interface: group-raw\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 5\n      special:\n        - alias\n        - group\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: date_created\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: datetime\n      display_options:\n        relative: true\n      field: date_created\n      group: null\n      hidden: true\n      interface: datetime\n      note: null\n      options: null\n      readonly: true\n      required: false\n      sort: 3\n      special:\n        - cast-timestamp\n        - date-created\n      translations: null\n      validation: null\n      validation_message: null\n      width: half\n    schema:\n      data_type: datetime\n      default_value: null\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: null\n      name: date_created\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: timestamp\n  - collection: auto_backup_settings\n    field: date_updated\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: datetime\n      display_options:\n        relative: true\n      field: date_updated\n      group: null\n      hidden: true\n      interface: datetime\n      note: null\n      options: null\n      readonly: true\n      required: false\n      sort: 5\n      special:\n        - cast-timestamp\n        - date-updated\n      translations: null\n      validation: null\n      validation_message: null\n      width: half\n    schema:\n      data_type: datetime\n      default_value: null\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: null\n      name: date_updated\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: timestamp\n  - collection: auto_backup_settings\n    field: divide_to_database_type\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: divide_to_database_type\n      group: general_settings\n      hidden: false\n      interface: presentation-divider\n      note: null\n      options:\n        inlineTitle: true\n        title: Database driver\n      readonly: false\n      required: false\n      sort: 6\n      special:\n        - alias\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: divider-oql-hz\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: divider-oql-hz\n      group: null\n      hidden: false\n      interface: presentation-divider\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 7\n      special:\n        - alias\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: divider-qtbpzx\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: divider-qtbpzx\n      group: general_settings\n      hidden: false\n      interface: presentation-divider\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 9\n      special:\n        - alias\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: divider_to_backup_location\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: divider_to_backup_location\n      group: general_settings\n      hidden: false\n      interface: presentation-divider\n      note: null\n      options:\n        inlineTitle: true\n        title: Backup location\n      readonly: false\n      required: false\n      sort: 2\n      special:\n        - alias\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: driver_specific_settings\n    meta:\n      collection: auto_backup_settings\n      conditions:\n        - name: Visible\n          rule:\n            _and:\n              - DB_CLIENT:\n                  _null: true\n          hidden: true\n          options: {}\n      display: null\n      display_options: null\n      field: driver_specific_settings\n      group: general_settings\n      hidden: false\n      interface: group-raw\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 8\n      special:\n        - alias\n        - group\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: general_settings\n    meta:\n      collection: auto_backup_settings\n      conditions:\n        - name: Open\n          rule:\n            _and:\n              - active:\n                  _eq: false\n          options:\n            start: open\n      display: null\n      display_options: null\n      field: general_settings\n      group: null\n      hidden: false\n      interface: group-detail\n      note: null\n      options:\n        start: closed\n      readonly: false\n      required: false\n      sort: 6\n      special:\n        - alias\n        - group\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: id\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: id\n      group: null\n      hidden: true\n      interface: input\n      note: null\n      options: null\n      readonly: true\n      required: false\n      sort: 1\n      special: null\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: integer\n      default_value: null\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: true\n      is_generated: false\n      is_nullable: false\n      is_primary_key: true\n      is_unique: false\n      max_length: null\n      name: id\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: integer\n  - collection: auto_backup_settings\n    field: latest_log\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: latest_log\n      group: visibility_active\n      hidden: false\n      interface: input-multiline\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 1\n      special: null\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: text\n      default_value: null\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: null\n      name: latest_log\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: text\n  - collection: auto_backup_settings\n    field: notice_finished\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: notice_finished\n      group: general_settings\n      hidden: false\n      interface: presentation-notice\n      note: null\n      options:\n        text: After this setup, you only need to active the next field ACTIVE\n      readonly: false\n      required: false\n      sort: 10\n      special:\n        - alias\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: notice_welcome\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: notice_welcome\n      group: general_settings\n      hidden: false\n      interface: presentation-notice\n      note: null\n      options:\n        text: >-\n          Welcome to the auto backup extension. Please configure this setup.\n          After that set the field ACTIVE to true\n      readonly: false\n      required: false\n      sort: 1\n      special:\n        - alias\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: sqlite3_db_filename\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: sqlite3_db_filename\n      group: sqlite3_settings\n      hidden: false\n      interface: input\n      note: >-\n        Default from:\n        https://docs.directus.io/self-hosted/installation/docker.html\n      options: null\n      readonly: false\n      required: false\n      sort: 1\n      special: null\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: varchar\n      default_value: /directus/database/data.db\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 255\n      name: sqlite3_db_filename\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: string\n  - collection: auto_backup_settings\n    field: sqlite3_settings\n    meta:\n      collection: auto_backup_settings\n      conditions:\n        - rule:\n            _and:\n              - DB_CLIENT:\n                  _neq: sqlite3\n          readonly: false\n          hidden: true\n          required: false\n          options: {}\n          name: Visibility\n      display: null\n      display_options: null\n      field: sqlite3_settings\n      group: driver_specific_settings\n      hidden: false\n      interface: group-raw\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 2\n      special:\n        - alias\n        - group\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\n  - collection: auto_backup_settings\n    field: state\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: null\n      display_options: null\n      field: state\n      group: null\n      hidden: false\n      interface: select-dropdown\n      note: >-\n        If you want to run auto backups, just create a directus flow and change\n        the field 'state' to the value 'check'\n      options:\n        choices:\n          - text: check <-- manual start\n            value: check\n          - text: running\n            value: running\n          - text: finished\n            value: finished\n          - text: failed\n            value: failed\n      readonly: false\n      required: false\n      sort: 9\n      special: null\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema:\n      data_type: varchar\n      default_value: finished\n      foreign_key_column: null\n      foreign_key_table: null\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 255\n      name: state\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: string\n  - collection: auto_backup_settings\n    field: user_created\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: user\n      display_options: null\n      field: user_created\n      group: null\n      hidden: true\n      interface: select-dropdown-m2o\n      note: null\n      options:\n        template: '{{avatar.$thumbnail}} {{first_name}} {{last_name}}'\n      readonly: true\n      required: false\n      sort: 2\n      special:\n        - user-created\n      translations: null\n      validation: null\n      validation_message: null\n      width: half\n    schema:\n      data_type: char\n      default_value: null\n      foreign_key_column: id\n      foreign_key_table: directus_users\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 36\n      name: user_created\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: string\n  - collection: auto_backup_settings\n    field: user_updated\n    meta:\n      collection: auto_backup_settings\n      conditions: null\n      display: user\n      display_options: null\n      field: user_updated\n      group: null\n      hidden: true\n      interface: select-dropdown-m2o\n      note: null\n      options:\n        template: '{{avatar.$thumbnail}} {{first_name}} {{last_name}}'\n      readonly: true\n      required: false\n      sort: 4\n      special:\n        - user-updated\n      translations: null\n      validation: null\n      validation_message: null\n      width: half\n    schema:\n      data_type: char\n      default_value: null\n      foreign_key_column: id\n      foreign_key_table: directus_users\n      generation_expression: null\n      has_auto_increment: false\n      is_generated: false\n      is_nullable: true\n      is_primary_key: false\n      is_unique: false\n      max_length: 36\n      name: user_updated\n      numeric_precision: null\n      numeric_scale: null\n      table: auto_backup_settings\n    type: string\n  - collection: auto_backup_settings\n    field: visibility_active\n    meta:\n      collection: auto_backup_settings\n      conditions:\n        - name: Visibility\n          rule:\n            _and:\n              - active:\n                  _eq: true\n          options: {}\n      display: null\n      display_options: null\n      field: visibility_active\n      group: null\n      hidden: false\n      interface: group-raw\n      note: null\n      options: null\n      readonly: false\n      required: false\n      sort: 10\n      special:\n        - alias\n        - group\n        - no-data\n      translations: null\n      validation: null\n      validation_message: null\n      width: full\n    schema: null\n    type: alias\nrelations:\n  - collection: auto_backup_settings\n    field: user_created\n    meta:\n      junction_field: null\n      many_collection: auto_backup_settings\n      many_field: user_created\n      one_allowed_collections: null\n      one_collection: directus_users\n      one_collection_field: null\n      one_deselect_action: nullify\n      one_field: null\n      sort_field: null\n    related_collection: directus_users\n    schema:\n      column: user_created\n      constraint_name: null\n      foreign_key_column: id\n      foreign_key_table: directus_users\n      on_delete: NO ACTION\n      on_update: NO ACTION\n      table: auto_backup_settings\n  - collection: auto_backup_settings\n    field: user_updated\n    meta:\n      junction_field: null\n      many_collection: auto_backup_settings\n      many_field: user_updated\n      one_allowed_collections: null\n      one_collection: directus_users\n      one_collection_field: null\n      one_deselect_action: nullify\n      one_field: null\n      sort_field: null\n    related_collection: directus_users\n    schema:\n      column: user_updated\n      constraint_name: null\n      foreign_key_column: id\n      foreign_key_table: directus_users\n      on_delete: NO ACTION\n      on_update: NO ACTION\n      table: auto_backup_settings\n"}(),je=s,Me=class{constructor(n,e,t){this.database=e,this.services=n,this.schema=t,this.backupSettings=new Ie(n,e,t),this.finished=!0,this.filesService=this.getFileService(t,n),this.foldersService=this.getFolderService(t,n)}getFileService(n,e){return new e.FilesService({schema:n,accountability:null})}getFolderService(n,e){return new e.FoldersService({schema:n,accountability:null})}async init(){await this.backupSettings.init()}async log(n,e){return n+=(new Date).toISOString()+": "+e+"\n\n"}async getNewBackupFilenameWithoutExtension(){let n=new Date;return"backup-"+n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate()+"-"+n.getHours()+"-"+n.getMinutes()+"-"+n.getSeconds()+"-"+n.getMilliseconds()}async getDirectusRootFolderPath(){let n=Ne.join(__dirname,"./../../../../");return Ne.resolve(n)}async createFolderIfNotExists(n){Fe.existsSync(n)||Fe.mkdirSync(n,{recursive:!0})}async getTempFolderPath(){let n=await this.getDirectusRootFolderPath();return Ne.join(n,"directus","database","temp")}async deleteTempFolder(n){let e=await this.getTempFolderPath();console.log("Delete temp folder: "+e),n=await this.log(n,"Delete temp folder: "+e),Fe.existsSync(e)&&Fe.rmSync(e,{recursive:!0}),console.log("Temp folder deleted"),n=await this.log(n,"Temp folder deleted")}getFileExtension(n){return Ne.extname(n)}async moveBackupFileToBackupFolder(n,e,t){console.log("Move backup file to backup folder"),t=await this.log(t,"Move backup file to backup folder");let i=this.getFileExtension(n),a=await this.getNewBackupFilenameWithoutExtension(e)+i;console.log("Backup filename: "+a),t=await this.log(t,"Backup filename: "+a);let l=await this.backupSettings.getBackupLocationType();if(console.log("Backup location type: "+l),t=await this.log(t,"Backup location type: "+l),this.backupSettings.isBackupLocationTypeFileLibrary(l)){let e=await this.backupSettings.getBackupLocationFileLibraryFolderName(),i=await this.backupSettings.getBackupLocationFileLibraryFolderID();if(console.log("Backup location folder name: "+e),t=await this.log(t,"Backup location folder name: "+e),console.log("Backup location folder id: "+i),t=await this.log(t,"Backup location folder id: "+i),i){console.log("Change folder name"),t=await this.log(t,"Change folder name"),await this.backupSettings.setBackupLocationFileLibraryFolderName("okay");let e=Ee.STORAGE_LOCATIONS||"";console.log("storageLocationsString: "+e),t=await this.log(t,"storageLocationsString: "+e);let l=e.split(",");console.log("storageLocations: "+l),t=await this.log(t,"storageLocations: "+l);let o={filename_download:a,folder:i,storage:l[0]};console.log("tempBackupFilePath url: "+n);let s=Fe.createReadStream(n);await this.filesService.uploadOne(s,o),console.log("Backup file moved to file library"),t=await this.log(t,"Backup file moved to file library")}else{console.log("Backup location folder id not set"),t=await this.log(t,"Backup location folder id not set");const n=await this.foldersService.createOne({name:e});if(console.log("Backup location folder created: "+n),t=await this.log(t,"Backup location folder created: "+n),i=n,!i)return console.log("Error: Could not create folder"),void(t=await this.log(t,"Error: Could not create folder"));console.log("Backup location folder id set: "+i),t=await this.log(t,"Backup location folder id set: "+i),await this.backupSettings.setBackupLocationFileLibraryFolderID(i)}}else if(this.backupSettings.isBackupLocationTypeCustomPath(l)){let e=await this.backupSettings.getBackupLocationCustomPath();console.log("Create if not exists: "+e),t=await this.log(t,"Create if not exists: "+e),await this.createFolderIfNotExists(e);let i=await this.getDirectusRootFolderPath(),l=Ne.join(i,e,a);try{return console.log("Move backup file to custom path: "+l),t=await this.log(t,"Move backup file to custom path: "+l),Fe.copyFileSync(n,l),t=await this.deleteTempFolder(t)}catch(n){return console.log(n),t=await this.log(t,n.toString()),t=await this.deleteTempFolder(t)}}}async createBackup(){let n="";n=await this.log(n,"Init start backup");let e=new Date,t=await this.getTempFolderPath();await this.createFolderIfNotExists(t);let i=null,a=await this.backupSettings.getDBClient();if(this.backupSettings.isSQLITE3DBClient(a)&&(n=await this.log(n,"SQLITE3 DB Client selected"),i=new Te(this,this.backupSettings,this.services,this.database,this.schema,this.log),await i.init()),i){let a=await i.createBackup(t);a?(console.log("Backup created and temporarily stored at: "+a),n=await this.log(n,"Backup created and temporarily stored at: "+a),n=await this.moveBackupFileToBackupFolder(a,e,n),console.log("Moved backup file to backup folder finished"),n=await this.log(n,"Moved backup file to backup folder finished")):(console.log("Backup failed, since no backup file was created"),n=await this.log(n,"Backup failed, since no backup file was created"))}else console.log("No specific controller found for db client: "+a),n=await this.log(n,"No specific controller found for db client: "+a)}async checkIfBackup(){if(await this.backupSettings.getActiveStatus()){let n=await this.backupSettings.getState(),e="finished",t="running",i="failed";if(n==="check"&&this.finished){this.finished=!1,await this.backupSettings.setCurrentState(t);try{await this.createBackup(),this.finished=!0,await this.backupSettings.setCurrentState(e)}catch(n){await this.backupSettings.setLatestLog(n.toString()),this.finished=!0,await this.backupSettings.setCurrentState(i)}}else n===t||this.finished||await this.backupSettings.setCurrentState(t)}}},De=je.load(Be);module.exports=async function({filter:n,action:e,init:t,schedule:i},{services:a,exceptions:l,database:o,getSchema:s,logger:r}){try{console.log("Init auto backup");let n=await s();await async function(n,e,t){let i=new Oe(n,e,t),a=await i.getCollectionsService();try{let n=await a.readByQuery(),e=!1;for(let t of n)if(t.collection===qe.TABLENAME){e=!0;break}if(!e){console.log("Collection "+qe.TABLENAME+" not found");let n=De.collections[0],e=De.fields;console.log("Creating "+qe.TABLENAME+" collection"),await a.createOne({...n,fields:e}),console.log("Created "+qe.TABLENAME+" collection")}}catch(n){console.log(n)}}(a,o,n);let t=new Me(a,o,n);await t.init(),e(qe.TABLENAME+".items.update",(async(n,e)=>{try{await t.checkIfBackup()}catch(n){console.log(n)}}))}catch(n){n.toString().includes("no such table: directus_collections")?(console.log("++++++++++ Auto Backup +++++++++++"),console.log("++++ Database not initialized yet +++++"),console.log("++ Restart Server again after setup +++"),console.log("+++++++++++++++++++++++++++++++++++++++")):(console.log("Auto-Translation init error: "),console.log(n))}};
